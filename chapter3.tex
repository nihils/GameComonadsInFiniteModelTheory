\chapter{Ehrenfreucht-{\Fraisse} Comonad}
\section{Introduction}
The Ehrenfreucht-{\Fraisse} (EF) game was the first case of a two-player game used to prove equivalence between structures in fragments of first-order logic. In particular, the EF game is used to prove equivalence between structures in the $k$-rank fragments of first order logic. Other games, such as the pebbling game and bisimulation game, are essentially modifications of the EF game. Given two structures $A,B$, the Ehrenfreucht-{\Fraisse} game has two players, Spoiler and Duplicator. A $k$-round (symmetric) EF game, denoted $\efgameSym{k}{A}{B}$, is played as follows: for every $i \in [k]$, 
\begin{itemize}
\item Spoiler chooses an element in either structure $a_{i} \in A$ or $b_{i} \in B$. 
\item Duplicator chooses an element in the other structure $b_{i} \in B$ or $a_{i} \in A$  
\end{itemize}
At the end of the $k$-round game, $k$-tuples $(a_{1},\dots,a_{k})$ and $(b_{1},\dots,b_{k})$ have been chosen. Duplicator wins the $k$-round game if the map $\chi:a_{i} \longmapsto b_{i}$ is a partial $\sigma$-isomorphism from $A$ to $B$. Otherwise, Spoiler wins. The asymmetric (or existential positive) game from $A$ to $B$, denoted $\efgame{k}{A}{B}$, is the same game with the additional restriction that Spoiler must always play an element in $A$ and the map $\chi$ obtained is a partial $\sigma$-morphism. Hence, Duplicator must always respond in $B$. The following result is standard in any model theory text:
\begin{prop}
The following are equivalent:
\begin{itemize}
\item Duplicator has a winning strategy $\efgameSym{k}{A}{B}$
\item $\equivL{A}{B}{\mathcal{L}_{\omega,k}}$, i.e. for every sentence $\phi \in \mathcal{L}_{\omega,k}$, $A \vDash \phi \Leftrightarrow B \vDash \phi$
\end{itemize}
\end{prop}
The goal of the EF comonad is to construct a $\sigma$-structure $\efcomonad{k}{A}$ from a $\sigma$-structure $A$, that ``internalizes'' $\efgame{k}{A}{B}$ and $\efgameSym{k}{A}{B}$ into the category $\mathcal{R}(\sigma)$.  
\section{Comonad laws}
Let $A$ be a $\sigma$-structure over relational signature $\sigma$, then for every $k \in \omega$ we define a $\sigma$-structure $\efcomonad{k}{A}$. Intuitively, $\efcomonad{k}{A}$ is the structure of Spoiler's strategies in the Ehrenfreucht-{\Fraisse} $k$-round asymmetric game from $A$ to any $\sigma$-structure. A function $f:\efcomonad{k}{A} \longrightarrow B$, then represents Duplicator's strategy (i.e. responses) to Spoiler's plays in the $k$-round asymmetric game from $A$ to $B$. For every $i \in \omega$, let $A^{i}$ be the set of $i$-length sequences of elements in $A$. Let the domain of the structure be $|\efcomonad{k}{A}| = \bigcup_{i \leq k} A^{i}$. 
\begin{defn}
Define, for every $\sigma$-structure $A$, $\epsilon_{A}:\efcomonad{k}{A} \longrightarrow A$ by $[a_{1},\dots,a_{n}] \mapsto a_{n}$ (i.e. the last move of the play). 
\label{defn:epsilonEF}
\end{defn}
With this definitions in place, we can define a $\sigma$-structure on $\efcomonad{k}{A}$. Suppose $R \in \sigma$ is a $m$-ary relation, the we define the interpretation of $R^{\efcomonad{k}{A}}$ such that for every $s_{1},\dots,s_{m} \in |\efcomonad{k}{A}|$,
\begin{align}
(s_{1},\dots,s_{m}) \in R^{\efcomonad{k}{A}} &\Leftrightarrow \text{ for every $i,j \leq m$, } s_{i} \sqsubseteq s_{j} \text{ or } s_{j} \sqsubseteq s_{i} & \label{eq:R1st} \\ 
&\text{ and } (\epsilon_{A}(s_{1}),\dots,\epsilon_{A}(s_{m})) \in R^{A} & \label{eq:R2nd}
\end{align}
\begin{defn}
Given a morphism $f:A \longrightarrow B$, define the morphism $\efcomonad{k}{f}:\efcomonad{k}{A} \longrightarrow \efcomonad{k}{B}$ by $[a_{1},\dots,a_{n}] \mapsto [f(a_{1}),\dots,f(a_{n})]$
\label{defn:comonadMorphismEF}
\end{defn}
\begin{prop}
The definition (\ref{defn:comonadMorphismEF}) of $\efcomonad{k}{f}:\efcomonad{k}{A} \longrightarrow \efcomonad{k}{B}$ given above is indeed a morphism of $\sigma$-structures. 
\begin{proof}
Suppose $R \in \sigma$, then we want to show that if $(s_{1},\dots,s_{m}) \in R^{\efcomonad{k}{A}}$, then \linebreak $(\efcomonad{k}{f}(s_{1}),\dots,\efcomonad{k}{f}(s_{m})) \in R^{\efcomonad{k}{B}}$. For brevity, assume that $R$ is a binary relation (the proof for a general $m$-ary relation is a straightforward generalization). Suppose $s,s' \in \efcomonad{k}{A}$ such that $(s,s') \in R^{\efcomonad{k}{A}}$. Let $s = [a_{1},\dots,a_{n}]$ and $s' = [a_{1},\dots,a'_{m}]$. We aim to show that $(\efcomonad{k}{f}(s),\efcomonad{k}{f}(s')) \in R^{\efcomonad{k}{B}}$ \\
\begin{enumerate}
\item  Since $(s,s') \in R^{\efcomonad{k}{A}}$, by condition (\ref{eq:R1st}), $s \sqsubseteq s'$ or $s' \sqsubseteq s$. Without loss of generality, assume $s \sqsubseteq s'$. Since $s \sqsubseteq s'$.
$$s' = [a_{1},\dots,a_{n},a'_{n+1},\dots,a'_{m}]$$ 
(noting that for $i \leq n$, $a_{i} = a'_{i}$). Therefore $$\efcomonad{k}{f}(s) = [f(a_{1})),\dots,f(a_{n})]$$ 
$$\efcomonad{k}{f}(s') =[f(a_{1}),\dots,f(a_{n}),f(a'_{n+1}),\dots,f(a'_{m})]$$ 
Hence, $\efcomonad{k}{f}(s) \sqsubseteq \efcomonad{k}{f}(s')$ and (\ref{eq:R1st}) is satisfied. 
\item  By condition (\ref{eq:R2nd}) and $(s,s') \in R^{\efcomonad{k}{f}}$, $(\epsilon_{A}(s),\epsilon_{A}(s')) = (a_{n},a'_{m}) \in R^{A}$. Since $f:A \rightarrow B$ is a morphism of $\sigma$-structures, $(f(a_{n}),f(a'_{m})) \in R^{B}$. That is, $(\epsilon_{B}\circ \efcomonad{k}{f}(s),\epsilon_{B} \circ \efcomonad{k}{f}(s')) \in R^{B}$. Hence, (\ref{eq:R2nd}) is satisfied.
\end{enumerate}
Therefore, $(\efcomonad{k}{f}(s),\efcomonad{k}{f}(s')) \in R^{\efcomonad{k}{B}}$ and $\efcomonad{k}{f}$ is indeed a morphism of $\sigma$-structures. 
\end{proof}
\end{prop}
\begin{prop}
$\epsilon:\efcomonad{k}{} \longrightarrow 1_{\mathcal{R}(\sigma)}$ is a natural transformation.
\begin{proof}
For every $A,B \in \mathcal{R}(\sigma)$ we want to show that:
\begin{equation}
\bfig \square[\efcomonad{k}{A}`A`\efcomonad{k}{B}`B;\epsilon_{A}`\efcomonad{k}{f}`f`\epsilon_{B}] \efig
\label{eq:epsilonNEF}
\end{equation}
\begin{align*}
f \circ \epsilon_{A}([a_{1},\dots,a_{n})])  &= f(a_{n}) & \text{defn (\ref{defn:epsilonEF}) $\epsilon_{A}$}\\
&= \epsilon_{B}([f(a_{1}),\dots,f(a_{n})]) & \text{defn (\ref{defn:epsilonEF}) $\epsilon_{B}$}\\
&= \epsilon_{B} \circ \efcomonad{k}{f}([a_{1},\dots,a_{n}]) & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{f}$}
\end{align*}
Hence, the above diagram (\ref{eq:epsilonNEF}) commutes.
\end{proof}
\label{prop:epsilonNEF}
\end{prop}
\begin{defn}
Suppose $s \in \efcomonad{k}{A}$, then $s = [a_{1},\dots,a_{n}]$ for some $n \in \omega$ and for every $i = 1,\dots, n$, $a_{i} \in A$. Let $s_{i} = [a_{1},\dots,a_{i}] \in \efcomonad{k}{A}$. Define, for every $\sigma$-structure $A$, $\delta_{A}:\efcomonad{k}{A} \longrightarrow \efcomonad{k}{\efcomonad{k}{A}}$ by $s \mapsto [s_{1},\dots,s_{n}]$.
\label{defn:deltaEF}
\end{defn}
\begin{prop}
$\delta:\efcomonad{k} \longrightarrow \efcomonad{k}{\efcomonad{k}{}}$ is a natural transformation.
\begin{proof}
For every $A,B \in \mathcal{R}(\sigma)$ we want to show that:
\begin{equation}
\bfig \square[\efcomonad{k}{A}`\efcomonad{k}{\efcomonad{k}{A}}`\efcomonad{k}{B}`\efcomonad{k}{\efcomonad{k}{B}};\delta_{A}`\efcomonad{k}{f}`\efcomonad{k}{\efcomonad{k}{f}}`\delta_{B}] \efig
\label{eq:deltaNEF}
\end{equation}
\begin{align*}
\efcomonad{k}{\efcomonad{k}{f}} \circ \delta_{A}([a_{1},\dots,a_{n}])   &= \efcomonad{k}{\efcomonad{k}{f}}([s_{1},\dots,s_{n}]) & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$} \\
&= [\efcomonad{k}{f}(s_{1}),\dots,\efcomonad{k}{f}(s_{n})] & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{\efcomonad{k}{f}}$}\\
&= [[f(a_{1})],\dots,[f(a_{1}),\dots,f(a_{n})]] & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{f}$}\\
&= \delta_{B}([f(a_{1}),\dots,f(a_{n})]) & \text{defn (\ref{defn:deltaEF}) $\delta_{B}$} \\
&= \delta_{B} \circ \efcomonad{k}{f}([a_{1},\dots,a_{n}]) & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{f}$}
\end{align*}
Hence, the above diagram (\ref{eq:deltaNEF}) commutes.
\end{proof}
\label{prop:deltaNEF}
\end{prop}
\begin{thm}
The triple $\langle \efcomonad{k}{},\delta,\epsilon \rangle$ is a comonad.
\begin{proof}
By proposition (\ref{prop:deltaNEF}) and (\ref{prop:epsilonNEF}), $\delta$ and $\epsilon$ are natural transformation. Hence, $\delta$ and $\epsilon$ are indeed the comultiplication and counit of $\efcomonad{k}{}$. The associative and identity laws remain to be shown. \\
For associativity, for every $A \in \mathcal{R}(\sigma)$, the following diagram commutes:  
\begin{equation}
\bfig \Square[\efcomonad{k}{A}`\efcomonad{k}{\efcomonad{k}{A}}`\efcomonad{k}{\efcomonad{k}{A}}`\efcomonad{k}{\efcomonad{k}{\efcomonad{k}{A}}};\delta_{A}`\delta_{A}`\delta_{\efcomonad{k}{A}}`\efcomonad{k}{\delta_{A}}] \efig 
\end{equation}
\begin{align*}
\delta_{\efcomonad{k}{A}} \circ \delta_{A}([a_{1},\dots,a_{n}])     &= \delta_{\efcomonad{k}{A}}([s_{1},\dots,s_{n}]) & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$} \\
&= [[s_{1}],\dots,[s_{1},\dots,s_{n}]]  & \text{defn (\ref{defn:deltaEF}) $\delta_{\efcomonad{k}{A}}$}\\
&= [\delta_{A}(s_{1}),\dots,\delta_{A}(s_{n})] & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$}  \\
&= \efcomonad{k}{\delta_{A}}([s_{1},\dots,s_{n}]) & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{\delta_{A}}$}  \\
&= \efcomonad{k}{\delta_{A}} \circ \delta_{A}([a_{1},\dots,a_{n}]) & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$}\\
\end{align*}
For identity, for every $A \in \mathcal{R}(\sigma)$, the following diagram commutes:  
\begin{equation}
\bfig 
    \square[\efcomonad{k}{A}`\efcomonad{k}{\efcomonad{k}{A}}`\efcomonad{k}{\efcomonad{k}{A}}`\efcomonad{k}{A};\delta_{A}`\delta_{A}`\efcomonad{k}{\epsilon_{A}}`\epsilon_{\efcomonad{k}{A}}] 
    \morphism(0,500)/=/<500,-500>[\efcomonad{k}{A}`\efcomonad{k}{A};]
\efig 
\end{equation}
\begin{align*}
\efcomonad{k}{\epsilon_{A}} \circ \delta_{A}([a_{1},\dots,a_{n}]) &= \efcomonad{k}{\epsilon_{A}}([s_{1},\dots,s_{n}]) & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$}\\
&= [\epsilon_{A}(s_{1}),\dots,\epsilon_{A}(s_{n})]  & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{\epsilon_{A}}$}  \\
&= [a_{1},\dots,a_{n}] & \text{defn (\ref{defn:epsilonEF}) $\epsilon_{A}$}\\
&= s_{n} & \text{defn (\ref{defn:deltaEF}) $s_{n}$}\\
&= \epsilon_{\efcomonad{k}{A}}([s_{1},\dots,s_{n}]) & \text{defn (\ref{defn:epsilonEF}) $\epsilon_{\efcomonad{k}{A}}$} \\
&= \epsilon_{\efcomonad{k}{A}} \circ \delta_{A}([a_{1},\dots,a_{n}]) & \text{defn (\ref{defn:deltaEF}) $\delta_{A}$}
\end{align*}
By definition, $\efcomonad{k}{}$ is a comonad.
\end{proof}
\end{thm}
For every $l,k \in \omega$ such that $l \leq k$ and $\sigma$-structure $A$, there exists an inclusion $i_{A}^{l,k}: \efcomonad{l}{A} \longrightarrow \efcomonad{k}{A}$. 
\begin{prop}
The inclusion maps form a natural transformation $i^{l,k}:\efcomonad{l}{} \longrightarrow \efcomonad{k}{}$. Further, each map preserves the counit and comultiplication (i.e. each map is a morphism of comonads). 
\end{prop}
\begin{proof}
\begin{equation}
\bfig \square[\efcomonad{l}{A}`\efcomonad{k}{A}`\efcomonad{l}{B}`\efcomonad{k}{B};i^{l,k}_{A}`\efcomonad{l}{f}`\efcomonad{k}{f}`i^{l,k}_{B}]\efig
\end{equation}
\begin{align*}
\efcomonad{k}{f} \circ i^{l,k}_{A}([a_{1},\dots,a_{n}])     &= \efcomonad{k}{f}([a_{1},\dots,,a_{n}]) & \text{inclusion}\\
&= [f(a_{1}),\dots,f(a_{n})] &\text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{f}$} \\
&= i^{l,k}_{B}([f(a_{1}),\dots,f(a_{n})]) & \text{inclusion} \\ 
&= i^{l,k}_{B} \circ \efcomonad{l}{f}([a_{1},\dots,a_{n}]) & \text{defn (\ref{defn:comonadMorphismEF}) $\efcomonad{k}{f}$}
\end{align*}
\end{proof}
The grading given by these inclusion maps seem to suggest that there is a colimit object capturing the information of $\efcomonad{k}{A}$ for every $k \in \omega$. This is indeed the case. Consider the structure $\efcomonad{\omega}{A}$ with domain $|\efcomonad{\omega}{A}| = \bigcup_{k \in \omega} A^{k}$ where $A^{k}$ is the set of $k$-length sequences of elements in $A$. The structure on $\efcomonad{\omega}{A}$ is similar to the structure given to $\efcomonad{k}{A}$. 
\begin{prop}
Let $\omega$ be considered as a poset category under the usual order. The object $\efcomonad{\omega}{A}$ is the $\omega$-colimit of the family $\{\efcomonad{k}{A}\}_{k \in \omega}$ with the above inclusion maps. 
\begin{proof}
For every $k \in \omega$, define $i^{k}_{A}:\efcomonad{k}{A} \rightarrow \efcomonad{\omega}{A}$ as the inclusion (i.e. $[a_{1},\dots,a_{n}] \mapsto [a_{1},\dots,a_{n}]$ where $n \leq k$). Clearly, the following diagram commutes for all $l,k \in \omega$ with $l \leq k$
\begin{equation}
\bfig \Vtriangle[\efcomonad{l}{A}`\efcomonad{k}{A}`\efcomonad{\omega}{A};i^{l,k}_{A}`i^{l}_{A}`i^{k}_{A}]\efig
\label{eq:omegaColimitEF}
\end{equation}
Suppose that there exists a $\sigma$-structure $B$ and for every $l,k \in \omega$ with $l \leq k$, there exist morphisms $f^{l}:\efcomonad{l}{A} \longrightarrow B$, $f^{k}:\efcomonad{k}{A} \longrightarrow B$ such that $f^{l} = f^{k} \circ i^{l,k}$. Consider the morphism $u:\efcomonad{\omega}{A} \longrightarrow B$ given by $[a_{1},\dots,a_{n}] \mapsto f^{n}([a_{1},\dots,a_{n}])$. The following diagram commutes:
\begin{equation}
\bfig 
    \Vtriangle[\efcomonad{l}{A}`\efcomonad{k}{A}`\efcomonad{\omega}{A};i^{l,k}_{A}`i^{l}_{A}`i^{k}_{A}]
    \morphism(0,500)|l|/{@{>}@/^-7pt/}/<500,-1000>[\efcomonad{l}{A}`B;f^{l}]
    \morphism(1000,500)|r|/{@{>}@/^7pt/}/<-500,-1000>[\efcomonad{k}{A}`B;f^{k}]
    \morphism(500,0)|m|/.>/<0,-500>[\efcomonad{\omega}{A}`B;u]
\efig
\label{eq:omegaColimitUEF}
\end{equation}
Moreover, given the conditions on $f^{j}$ for all $j \in \omega$, $u$ is unique. Namely, suppose there exists a morphism $u':\efcomonad{\omega}{A} \longrightarrow B$ such that for all $j \in \omega$, $f^{j} = u' \circ i^{j}_{A}$. Suppose $s = [a_{1},\dots,a_{k}] \in \efcomonad{\omega}{A}$ then for all $j \geq k, s \in \efcomonad{j}{A}$.  
\begin{align*}
u(s)    &= f^{k}(s)  & \text{by defn of $u$}\\
        &= f^{j} \circ i^{k,j}_{A}(s) & \text{by (\ref{eq:omegaColimitUEF})} \\
        &= u' \circ i^{j}_{A} \circ i^{k,j}_{A}(s) & \text{by hypothesis on $u'$}  \\
        &= u' \circ i^{k}_{A}(s) & \text{by (\ref{eq:omegaColimitEF})} \\
        &= u'(s) & \text{by defn of inclusion} 
\end{align*}
Since $u(s) = u'(s)$ for all $s \in \efcomonad{\omega}{A}$, $u = u'$ so $u$ is unique as desired.  
\end{proof}
\end{prop}
\section{Positional Form and Equivalences}\label{sec:positionalFormEF}
In order to solidify the connection between the construction $\efcomonad{k}{}$ and the Ehrenfreucht-{\Fraisse} game, we have to encode the strategies in the game into ``positional form''. Intuitively, the positional form represents the set of positions of Spoiler and Duplicators' choices after a fixed number of rounds. This positional form is similar to the forth part of graded ``back-and-forth systems'' that are used in model theory texts to prove that the $k$-round symmetric EF game characterizes $\equivL{A}{B}{\mathcal{L}_{\omega,k}}$. \\~\\
Let $\Gamma_{k}(A,B) = (A \times B)^{\leq k}$ (i.e. sequences in pairs of elements in $A,B$ with length $\leq k$). Recall that for a $\sigma$-morphism $f:\efcomonad{k}{A} \longrightarrow B$, there exists the Kleisli coextension $f^{*}:\efcomonad{k}{A} \longrightarrow \efcomonad{k}{B}$. Define the set function $\theta_{f}:|\efcomonad{k}{A}| \longrightarrow \Gamma_{k}(A,B)$ by $s = [a_{1},\dots,a_{n}] \mapsto [(a_{1},b_{1}),\dots,(a_{n},b_{n})]$ where $f^{*}(s) = [b_{1},\dots,b_{n}]$. Rephrasing, $\theta_{f} = z \circ \langle \mathsf{id}_{\efcomonad{k}{A}},f^{*} \rangle \circ \Delta_{A}$ where $z$ is the `zipper' function sending two sequences of equal length to the natural sequence of pairs, and $\Delta_{A}:A \longrightarrow A \times A$ is the natural diagonal function.  
\begin{defn}
$S \subseteq \Gamma_{k}(A,B)$ is a \textit{strategy in positional form} if $S$ satisfies the following conditions:
\begin{enumerate}[label=(S\arabic*),ref=S\arabic*,start=0]
\item $\emptySeq \in S$ \label{eq:S1st}
\item For all $\chi \in S$ with $|\chi| < k$, $a \in A$, there exists a unique $b \in B$ such that $\chi[(a,b)] \in S$ \label{eq:S2nd}
\item $S$ is reachable: For all $\chi \in S$, there is a chain \label{eq:S3rd}
$$\chi_{0} \longrightarrow \dots \longrightarrow \chi_{n}$$
such that $\chi_{0} = \emptySeq$, $\chi_{n} = \chi$ and $\chi_{i} \in S$ with $|\chi_{i}| = i$ for all $i = 0,\dots,n$. 
\end{enumerate}
\end{defn}
\begin{prop}
If $f:\efcomonad{k}{A} \longrightarrow B$ is a $\sigma$-morphism, then there exists a strategy in positional form $S_{f}$.
\begin{proof}
Define
$$S_{f} = \{\theta_{f}(s) \mid s \in \efcomonad{k}{A}\} \cup \{\emptySeq\}$$
\begin{itemize}
\item $\emptySeq \in S_{f}$, so (\ref{eq:S1st}) is satisfied.
\item Suppose $\chi \in S_{f}$ with $|\chi| < k$ and $a \in A$. By definition of $S_{f}$ either $\chi = \emptySeq$ or $\chi = \theta_{f}(s)$ for some $s \in \efcomonad{k}{A}$. In the first case, consider $\theta_{f}([a]) = [(a,b)] \in S$ with $b = f([a])$. In the second case, consider $\chi' = \theta_{f}(s[a])$. Since $|\chi| < k$, the length $|s| = j$ and the length $|s[a]| = j+1 \leq k$. Hence, $s[a]$ is indeed in $\efcomonad{k}{A}$. Therefore, $\chi' \in S_{f}$ and $\chi' = \chi[(a,b)]$ where $b = f(s[a])$.  
\item Suppose $\chi \in S_{f}$, then $\chi = \theta_{f}(s)$ (the $\chi = \emptySeq$ case is trivial) for some $s = [a_{1},\dots,a_{n}] \in \efcomonad{k}{A}$. Let $s_{i} = [a_{1}.\dots,a_{i}]$ be the $i$-th element of $\delta_{A}(s) \in \efcomonad{k}{\efcomonad{k}{A}}$, then
$$ \emptySeq \longrightarrow \theta_{f}(s_{1}) \longrightarrow \dots \longrightarrow \theta_{f}(s_{n}) = \chi$$
Hence, $S_{f}$ is reachable
\end{itemize}
\end{proof}
\label{prop:fToPosFormEF}
\end{prop}
\begin{prop}
Conversely, for every strategy in positional form $S$ there exists a $f:\efcomonad{k}{A} \rightarrow B$ such that $S = S_{f}$
\begin{proof}
$S_{f} \subseteq S$ The approach is to construct an appropriate $f$. Define $\pi_{1}:\Gamma_{k}(A,B) \longrightarrow \efcomonad{k}{A}$ by $\pi_{1}:[(a_{1},b_{1}),\dots,(a_{n},b_{n})] \longrightarrow [a_{1},\dots,a_{n}]$ and $\pi_{2}:\Gamma_{k}(A,B) \longrightarrow \efcomonad{k}{B}$ by $\pi_{2}:[(a_{1},b_{1}),\dots,(a_{n},b_{n})] \longrightarrow [b_{1},\dots,b_{n}]$. We construct $f$ by recursion, up to $k$, on the length of a play $s \in \efcomonad{k}{A}$. \\ 
\textit{Base Case:} Suppose $s = [a]$ for $a \in A$. By (\ref{eq:S1st}) and (\ref{eq:S2nd}), there exists a unique $b$ such that $[a,b] \in S$. Let $f(s) = b$. \\    
\textit{Recursive Step:} Assume for the recursion, that $f(s)$ is defined for $|s| = n < k$ and that $\theta_{f}(s) \in S$. Consider $s' = s[a]$. By (\ref{eq:S2nd}), there exists a unique $b \in B$ such that $\chi' = \theta_{f}(s)[a,b]$. Let $f(s') = b$. \\      
$S \subseteq S_{f}$ For every $\chi$, we need to show that there exists an $s \in \efcomonad{k}{A}$ such that $\theta_{f}(s) = \chi$ for the $f$ constructed above. Consider $s = \pi_{1}(\chi)$. By construction, $\theta_{f}(s) = \theta_{f}(\pi_{1}(\chi)) = \chi$.
\end{proof}
\label{prop:posFormToFEF}
\end{prop}
\subsection{Equivalence $\exists^{+}\mathcal{L}_{\omega,k}$}
\begin{defn}
A position $\chi = [(a_{1},b_{1}),\dots,(a_{n},b_{n})] \in \Gamma_{k}(A,B)$ is \textit{winning for Duplicator in $\efgame{k}{A}{B}$} if the map $\chi:a_{i} \longmapsto b_{i}$ is a partial $\sigma$-morphism from $A$ to $B$.  
Naturally, we can extend the definition to say that a strategy in positional form $S \subseteq \Gamma_{k}(A,B)$ is \textit{winning for Duplicator in $\efgame{k}{A}{B}$} if for all $\chi \in S$, $\chi$ is winning for Duplicator. Function $f:\efcomonad{k}{A} \longrightarrow B$ is \textit{winning for Duplicator in $\efgame{k}{A}{B}$} if $S_{f}$ is winning for Duplicator in $\efgame{k}{A}{B}$.
\end{defn}
Consider the expanded signature $\sigma' = \sigma \cup \{I\}$ with $I$ a binary relation. In order to prove the theorem, it is necessary to lift $\sigma$-structures to $\sigma'$-structures. We say a $\sigma$-structure $A$ is a \textit{pure $\sigma'$-structure} if $I$ is interpreted as the identity relation on $A$. Note that if $A$ is a pure $\sigma'$-structure, then by the definition of $\efcomonad{k}{A}$ as a $\sigma'$-structure, $\efcomonad{k}{A}$ is not a pure $\sigma'$-structure. However, two prefix comparable plays in $\efcomonad{k}{A}$ are $I$-related if their last elements are the same. This ensures that $S_{f}$ contains well-defined partial functions.
\begin{thm}
If $A,B$ are pure $\sigma'$-structures and $f:\efcomonad{k}{A} \rightarrow B$ is a function, then 
\center{$f:\efcomonad{k}{A} \longrightarrow B$ is a $\sigma'$-morphism if and only if  $f$ is winning for Duplicator in $\efgame{k}{A}{B}$}
\begin{proof}
$\Rightarrow$ Suppose $\chi \in S_{f}$, then by definition of $S_{f}$, $\chi = \emptySeq$ or $\chi = \theta_{f}(s)$ for some $s \in \efcomonad{k}{A}$. If $\chi = \emptySeq$, then it is vacuously true that $\chi$ is a partial homomorphism (i.e. winning for Duplicator). If $\chi = \theta_{f}(s)$, then there exists some $s \in \efcomonad{k}{A}$ such that $s = [a_{1},\dots,a_{n}]$ where $f([a_{1},\dots,a_{i}]) = b_{i}$ and $\chi = [(a_{1},b_{1}),\dots,(a_{n},b_{n})]$ for all $i = 1,\dots,n$. For brevity, let $s_{i} = [a_{1},\dots,a_{i}] \sqsubseteq s$ (i.e. $s_{i}$ is the $i$-th component of $\delta_{A}(s)$). \\
Suppose $R \in \sigma$ is a $m$-ary relation symbol, and $i_{1},\dots,i_{m} \in \{1,\dots,n\}$ and $R^{A}(a_{i_{1}},\dots,a_{i_{m}})$, then:
\begin{align*}
(a_{i_{1}},\dots,a_{i_{m}}) \in R^{A} &\Rightarrow (\epsilon_{A}(s_{i_{1}}),\dots,\epsilon_{A}(s_{i_{m}})) \in R^{A} & \text{by defn of $\epsilon_{A}$} \\
\text{(and } s_{i_{\mu}} \sqsubseteq s_{i_{\nu}} \text{ or } s_{i_{\nu}} \sqsubseteq s_{i_{\mu}} &\text{ for all } \nu,\mu = 1,\dots,m\text{)} &\text{by each } s_{i_{*}} \sqsubseteq s \\
&\Rightarrow (s_{i_{1}},\dots,s_{i_{m}}) \in R^{\efcomonad{k}{A}} & \text{by interpretation of $R$ on $\efcomonad{k}{A}$} \\
&\Rightarrow (f(s_{i_{1}}),\dots,f(s_{i_{m}})) \in R^{B} & \text{by hypothesis $f$ is $\sigma$-morphism}\\
&\Rightarrow (b_{i_{1}},\dots,b_{i_{m}}) \in R^{B}
\end{align*}
Hence, $\chi$ preserves relations.
Moreover, for $a_{i}$ and $a_{j}$ appearing in $s$ with $a_{i} = a_{j}$, then:
\begin{align*}
a_{i} = a_{j}       &\Rightarrow (a_{i},a_{j}) \in I^{A} & \text{by $A$ a pure $\sigma'$-structure} \\
&\Rightarrow (\epsilon_{A}(s_{i}),\epsilon_{A}(s_{j})) \in I^{A} & \text{by defn of $\epsilon_{A}$} \\
\text{(and } s_{i} \sqsubseteq s_{j} &\text{ or } s_{j} \sqsubseteq s_{i}\text{)} &\text{by each } s_{*} \sqsubseteq s \\
&\Rightarrow (s_{i},s_{j}) \in I^{\efcomonad{k}{A}} & \text{by interpretation of $I$ on $\efcomonad{k}{A}$} \\
&\Rightarrow (f(s_{i}),f(s_{j})) \in I^{B} & \text{by hypothesis $f$ is a $\sigma'$-morphism} \\
&\Rightarrow (b_{i},b_{j}) \in I^{B}\\
&\Rightarrow b_{i} = b_{j} & \text{by $B$ a pure $\sigma'$-structure}
\end{align*}
Hence, $\chi$ is a well-defined partial function.
Therefore, $\chi$ is indeed a partial homomorphism. Hence, for all $\chi \in S_{f}$, $\chi$ is winning for Duplicator. Therefore, by definition, $S_{f}$ is winning for Duplicator.
\\~\\
$\Leftarrow$ Suppose $(s_{1},\dots,s_{m}) \in R^{\efcomonad{k}{A}}$ for $R \in \sigma'$ (including $I$), then by the interpretation of $R$ on $\efcomonad{k}{A}$, there exists some prefix order greatest element $s \in \{s_{1},\dots,s_{m}\}$ such that for all $i$, $s_{i} \sqsubseteq s$. Consider $\chi = \theta_{f}(s) \in S_{f}$. By $s_{i} \sqsubseteq s$ and definition of $\theta_{f}$, $(\epsilon_{A}(s_{1}),f(s_{1})),\dots, (\epsilon_{A}(s_{m}),f(s_{m}))$ appear in $\chi$. Since $(\epsilon_{A}(s_{1}),\dots,\epsilon_{A}(s_{m})) \in R^{A}$ and $\chi$ is a partial homomorphism (i.e. winning for Duplicator), $(f(s_{1}),\dots,f(s_{m})) \in R^{B}$. Hence, $f$ is a $\sigma'$-morphism.
\end{proof}
\label{thm:toPositionalFormEF}
\end{thm}
Once in terms of positional form, we can complete the proof that $\efcomonad{k}{}$ indeed captures equivalence in $\exists^{+}\mathcal{L}_{\omega,k}$. Essentially, using the positional form, we reproduce the forth part of the Ehrenfreucht-{\Fraisse} theorem conventional in many model-theoretic texts. In particular, the following proof is modification of the proof of \cite[Theorem 3.18]{Libkin2004}. 
\begin{prop}
For all $k \in \omega$, the following are equivalent:
\begin{enumerate}[label=(\arabic*)$_{k}$]
\item For every $\phi \in \exists^{+}\mathcal{L}_{\omega,k}$, $A \vDash \phi \Rightarrow B \vDash \phi$
\item There exists a strategy in positional form $S \subseteq \Gamma_{k}(A,B)$ that is winning for Duplicator 
\end{enumerate}
\begin{proof}
$\Rightarrow$ By recursion on $k$, we construct $S$. \\
\textit{Base Case:} If $k = 0$, then the let $S = \{\emptySeq\}$. The condition that $\emptySeq$ is winning for Duplicator, means $A$ and $B$ satisfy the same atomic sentences. \\
\textit{Inductive Step:} Assume for the inductive hypothesis that there exists a strategy in positional form $S_{k} \subseteq \Gamma_{k}(A,B)$ that is winning for Duplicator. By hypothesis, we may also assume that (1)$_{k+1}$ (i.e. that for all $\phi \in \exists^{+}\mathcal{L}_{\omega,k+1}$, $A \vDash \phi \Rightarrow B \vDash \phi$). For every $a \in A$, consider the set of formulas: 
$$\text{tp}^{k}_{1}(a) := \{\psi(x) \in \exists^{+}\mathcal{L}_{\omega,k}: A,a \vDash\psi(x) \} $$ 
In model theory literature, this set is called the (existential-positive) rank-$k$ $1$-type of $a \in A$. Since there are only finitely many equivalence classes of formulas of rank-$k$, this type is isolated. That is, there exists a formula $\alpha(x) \in \text{tp}^{k}_{1}(a)$ such that for all $\psi(x) \in \text{tp}^{k}_{1}(a)$, $A,a \vDash \alpha(x) \Rightarrow A,a \vDash \psi(x)$. Consider the sentence $\phi = \exists x \alpha(x)$, clearly $A \vDash \phi$ as $a$ witnesses $x$. Since $\alpha$ is a rank-$k$ type, the sentence $\phi \in \exists^{+}\mathcal{L}_{\omega,k+1}$. By hypothesis (i.e (1)$_{k+1}$) and $A \vDash \phi$, $B \vDash \phi$. Hence, there exists a $b \in B$ corresponding to $a$, such that $B,b \vDash \alpha(x)$.  Let $\chi'_{a} = \chi[a,b]$ for every $\chi \in S$, $a \in A$.  Define
$$S_{k+1} =  S_{k} \cup \{\chi'_{a} : \chi \in S_{k} \text{ and }  a \in A \} \subseteq \Gamma_{k+1}(A,B)$$
It is clear by construction and the inductive hypothesis, that $S_{k+1}$ satisfies (\ref{eq:S1st})-(\ref{eq:S3rd}), so $S_{k+1}$ is a strategy in positional form. By the definition of the $\alpha$, for every $a \in A$, there exist $b \in B$ corresponding to $a$ such that for every $\psi(x) \in \exists^{+}\mathcal{L}_{\omega,k}, A \vDash \psi(a) \Rightarrow B \vDash \psi(b)$. Hence, $S_{k+1}$ is indeed winning for Duplicator. \\~\\
$\Leftarrow$ By induction on complexity of formulas $\psi(\mathbf{x}) \in \exists^{+}\mathcal{L}_{\omega,k+1}$, we prove the stronger statement of (1)$_{k+1}$ where the sentence $\phi$ is replaced with the formula $\psi(\mathbf{x})$ with free variables among $\mathbf{x}$ and $n \leq k+1$. Let $S \subseteq \Gamma_{k+1}(A,B)$ be the strategy in positional form winning for Duplicator that exists by hypothesis (i.e. (2)$_{k+1}$). \\
\textit{Base Case:} Suppose $\psi(\mathbf{x})$ is an atomic formula with variables among $\mathbf{x} = (x_{1},\dots,x_{n})$ and $\mathbf{a} = (a_{1},\dots,a_{n})$, then there are two cases: \\
$x_{i} = x_{j}$: Suppose $A,\mathbf{a} \vDash x_{i} = x_{j}$. By (\ref{eq:S2nd}), there exists $\chi \in S$ with $\chi = [(a_{i},b_{i}),(a_{j},b_{j})]$. By $S$ winning for Duplicator, $a_{i} \mapsto b_{i}$ is a partial $\sigma$-morphism, so $B,\mathbf{b} \vDash x_{i} = x_{j}$\\
$R(x_{i_{1}},\dots,x_{i_{m}})$: Suppose $A,\mathbf{a} \vDash R(x_{i_{1}},\dots,x_{i_{n}})$, so $(a_{i_{1}},\dots,a_{i_{m}}) \in R^{A}$ By (\ref{eq:S2nd}), there exists $\chi \in S$ with $\chi = [(a_{1},b_{1}),\dots,(a_{n},b_{n})]$. By $S$ winning for Duplicator, $\chi:a_{i} \mapsto b_{i}$ is a partial $\sigma$-morphism. Hence, $(b_{i_{1}},\dots,b_{i_{m}}) \in R^{B}$, so $B,\mathbf{b} \vDash R(b_{i_{1}},\dots,b_{i_{n}})$. \\
\textit{Inductive Step:} Assume for the inductive hypothesis that given formulas $\psi_{1}(\mathbf{x})$, $\psi_{2}(\mathbf{x})$ in $\exists^{+}\mathcal{L}_{\omega,k+1}$ there exists $\mathbf{a} = (a_{1},\dots,a_{n}) \in A^{n}$ such that $A,\mathbf{a} \vDash \psi_{j}(\mathbf{x}) \Rightarrow B,\mathbf{b} \vDash \psi_{j}(\mathbf{x})$ for some $\chi = [(a_{1},b_{1}),\dots,(a_{n},b_{n})] = z((\mathbf{a},\mathbf{b})) \in S$. There are three cases. For the $\psi(\mathbf{x}) = \psi_{1}(\mathbf{x}) \wedge \psi_{2}(\mathbf{x})$ case: 
\begin{align*}
A,\mathbf{a} \vDash \psi(\mathbf{x}) &\Rightarrow A,\mathbf{a} \vDash \psi_{1}(\mathbf{x}) \wedge \psi_{2}(\mathbf{x}) \\
&\Rightarrow A,\mathbf{a} \vDash \psi_{1}(\mathbf{x}) \text{ and } A,\mathbf{a} \vDash \psi_{2}(\mathbf{x}) \\
&\Rightarrow B,\mathbf{b} \vDash \psi_{1}(\mathbf{x}) \text{ and } B,\mathbf{b} \vDash \psi_{2}(\mathbf{x}) & \text{by the inductive hypothesis}\\
&\Rightarrow B,\mathbf{b} \vDash \psi_{1}(\mathbf{x}) \wedge \psi_{2}(\mathbf{x}) \\
&\Rightarrow B,\mathbf{b} \vDash \psi(\mathbf{x}) 
\end{align*}
The $\vee$ case is handled similarly. For the $\exists$ case, suppose $\psi(\mathbf{x}) = \exists y \varphi(y,\mathbf{x})$ with $\varphi \in \exists^{+}\mathcal{L}_{\omega,k}$ with the same assumptions as $\psi_{1},\psi_{2}$ then:  
\begin{align*}
A,\mathbf{a} \vDash \psi(\mathbf{x}) &\Rightarrow A,\mathbf{a} \vDash \exists y \varphi(y,\mathbf{x}) \\ 
&\Rightarrow \text{ there is some } a' \in A \text{ such that } A,a'\mathbf{a} \vDash \varphi(y,\mathbf{x}) 
\end{align*}
By (\ref{eq:S2nd}) and $\chi \in S$, there exists $b' \in B$ such that $\chi' = \chi[a',b'] \in S$ winning for Duplicator (i.e a partial homomorphism). Hence,
\begin{align*}
A,\mathbf{a} \vDash \psi(\mathbf{x}) &\Rightarrow \text{ there is some } b' \in B \text{ such that } B,b'\mathbf{b} \vDash \varphi(y,\mathbf{x}) \\  
&\Rightarrow B,\mathbf{b} \vDash \exists y \varphi(y,\mathbf{x}) \\  
&\Rightarrow B,\mathbf{b} \vDash \psi(\mathbf{x})   
\end{align*}
Therefore, for all $\psi(\mathbf{x}) \in \exists^{+}\mathcal{L}_{\omega,k+1}$ with $n \leq k+1$, there exists $\mathbf{a} \in A^{n}$ and $\mathbf{b} \in B^{n}$ such that $A,\mathbf{a} \vDash \psi(\mathbf{x}) \Rightarrow B,\mathbf{b} \vDash \psi(\mathbf{x})$. In particular, for sentences $\phi \in \exists^{+}\mathcal{L}_{\omega,k+1}$, $A \vDash \phi \Rightarrow B \vDash \phi$. 
\end{proof}
\begin{cor}
There exists a $\sigma'$-morphism $f:\efcomonad{k}{A} \longrightarrow B$ if and only if for all $\phi \in \exists^{+}\mathcal{L}_{\omega,k}, A \vDash \phi \Rightarrow B \vDash \phi$
\begin{proof}
Straightforward from theorem (\ref{thm:toPositionalFormEF}) and proposition (\ref{prop:toSyntaxEF}).
\end{proof}
\label{cor:forthOneEF}
\end{cor}
\begin{cor}
There exists $\sigma'$-morphisms $f:\efcomonad{k}{A} \longrightarrow B$, $g:\efcomonad{k}{B} \longrightarrow B$ if and only if $\equivL{A}{B}{\exists^{+}\mathcal{L}_{\omega,k}}$. 
\begin{proof}
Recall definition (\ref{defn:equivLogic}) and apply above corollary (\ref{cor:forthOneEF}) to $f$ and $g$.  
\end{proof}
\label{cor:forthEF}
\end{cor}
\label{prop:toSyntaxEF}
\end{prop}
\subsection{Equivalence $\mathcal{L}_{\omega,k}$}
The comonad $\efcomonad{k}{}$ also captures equivalence $\equivL{A}{B}{\mathcal{L}_{\omega,k}}$ in the full $k$-rank fragment of first-order logic. Equivalence in this logic is given by a winning strategy for Duplicator in the symmetric $k$-round EF game $\efgameSym{k}{A}{B}$. To formalize this in terms of $\sigma$-morphisms, we need winning strategies for Duplicator in $\efgame{k}{A}{B}$ given by $\sigma'$-morphism $f:\efcomonad{k}{A} \longrightarrow B$, and $\efgame{k}{B}{A}$ given by $\sigma'$-morphism $g:\efcomonad{k}{B} \longrightarrow A$, that are `sufficiently compatible', in positional form.  That is, these morphisms must form a back-and-forth system of partial isomorphisms. More precisely, for every pair of pure $\sigma'$-structures $A,B$, the positional forms are posets $\Gamma_{k}(A,B)$ and $\Gamma_{k}(B,A)$ ordered by $\sqsubseteq$. There is a canonical `swap' monotone function $()^{-}:\Gamma_{k}(A,B) \longrightarrow \Gamma_{k}(B,A)$ given by $[(a_{i},b_{i})]^{-} = [(b_{i},a_{i})]$. The condition that $f$ and $g$ are compatible, in positional form, can be phrased as $S_{f}^{-} = S_{g}$. It follows that $S_{g}^{-} = S_{f}$. 
\begin{defn}
A strategy in positional form $S \subseteq \Gamma_{k}(A,B)$ is \textit{winning for Duplicator in $\efgameSym{k}{A}{B}$} if $S$ is winning for Duplicator in $\efgame{k}{A}{B}$ and $S^{-}$ is winning for Duplicator in $\efgame{k}{B}{A}$. Naturally, we can extend this definition to functions, $f:\efcomonad{k}{A} \longrightarrow B$ is \textit{winning for Duplicator in $\efgameSym{k}{A}{B}$} if $S_{f}$ is winning for Duplicator in $\efgameSym{k}{A}{B}$.
\end{defn}
It follows by (\ref{prop:posFormToFEF}), that if $f$ is winning for Duplicator in $\efgameSym{k}{A}{B}$, there exists a function $g:\efcomonad{k}{B} \longrightarrow A$ such that $S_{g}$ is winning for Duplicator in $\efgame{k}{B}{A}$ and $S_{f}^{-} = S_{g}$, so $g$ is winning for Duplicator in $\efgameSym{k}{A}{B}$. This is the right definition to characterize equivalence in $\mathcal{L}_{\omega,k}$. To show this result, we modify the proof for (\ref{prop:toSyntaxEF}).  
\begin{prop}
For all $k \in \omega$, the following are equivalent:
\begin{enumerate}[label=(\arabic*)$_{k}$]
\item $\equivL{A}{B}{\mathcal{L}_{\omega,k}}$, i.e. for every $\phi \in \mathcal{L}_{\omega,k}$, $A \vDash \phi \Leftrightarrow B \vDash \phi$
\item There exists a strategy in positional form $S \subseteq \Gamma_{k}(A,B)$ such that $S$ is winning for Duplicator in $\efgameSym{k}{A}{B}$ 
\end{enumerate}
\begin{proof}
$\Rightarrow$ Repeat the proof for the $\Rightarrow$-direction of proposition (\ref{prop:toSyntaxEF}), but consider the full rank-$k$ 1-type of $a \in A$:
$$\text{tp}^{k}_{1}(a) := \{\psi(x) \in \mathcal{L}_{\omega,k}: A,a \vDash \psi(x) \} $$ 
This type is still isolated by a formula $\alpha(x)$ and proceed with the proof using this $\alpha(x)$. \\
$\Leftarrow$ We repeat the proof for the $\Leftarrow$-direction of proposition (\ref{prop:toSyntaxEF}), but with the additional $\neg$ and $\forall$ cases and a modified base case. For the base case, by (\ref{eq:S2nd}) and $S,S^{-}$ winning for Duplicator there exists a partial isomorphism $\chi:a_{i} \mapsto b_{i}$ for $\mathbf{a} = (a_{1},\dots,a_{n})$ and $\mathbf{b} = (b_{1},\dots,b_{n})$. Suppose $R \in \sigma$, then: 
\begin{align*}
A,\mathbf{a} \vDash R(x_{i_{1}},\dots,x_{i_{m}}) &\Leftrightarrow (a_{i_{1}},\dots,a_{i_{m}}) \in R^{A} \\
&\Leftrightarrow (b_{i_{1}},\dots,b_{i_{m}}) \in R^{B} & \text{by $\chi$ a partial isomorphism} \\
&\Leftrightarrow B,\mathbf{b} \vDash R(x_{i_{1}},\dots,x_{i_{m}})
\end{align*}
The proof for equality $=$ is similar. For the $\neg$-case, assume for the inductive hypothesis that given formula $\psi(\mathbf{x})$ with free variables among $\mathbf{x}$ in $\mathcal{L}_{\omega,k+1}$, there exists $\mathbf{a} = (a_{1},\dots,a_{n}) \in A^{n}$ such that $A,\mathbf{a} \vDash \psi(\mathbf{x}) \Leftrightarrow B,\mathbf{b} \vDash \psi(\mathbf{x})$ for some $\chi = [(a_{1},b_{1}),\dots,(a_{n},b_{n})] \in S$ and $\mathbf{b} = (b_{1},\dots,b_{n})$, then:
\begin{align*}
A,\mathbf{a} \vDash \neg\psi(\mathbf{x}) &\Leftrightarrow A,\mathbf{a} \not\vDash \psi(\mathbf{x}) \\
&\Leftrightarrow B,\mathbf{b} \not\vDash \psi(\mathbf{x})  & \text{contrapositive of inductive hypothesis}\\
&\Leftrightarrow B,\mathbf{b} \vDash \neg\psi(\mathbf{x}) 
\end{align*}
For the $\forall$-case, suppose $b \in B$, then by (\ref{eq:S2nd}) and $\chi^{-} \in S^{-}$ winning for Duplicator, there exists an $a \in A$ such that $\chi:a \mapsto b$. 
\begin{align*}
A,\mathbf{a} \vDash \psi(\mathbf{x})  &\Rightarrow A,\mathbf{a} \vDash \forall y \varphi(y,\mathbf{x}) \\
&\Rightarrow \text{ for all $c \in A$, } A,c\mathbf{a} \vDash \varphi(y,\mathbf{x}) \\
\text{In particular, for $c = a$,} &\Rightarrow A,a\mathbf{a} \vDash \varphi(y,\mathbf{x})\\
&\Rightarrow B,b\mathbf{b} \vDash \varphi(y,\mathbf{x}) & \text{by inductive hypothesis}\\
\text{Since $b \in B$ was arbitrary,} &\Rightarrow \text{ for all $b \in B$ }, B,b\mathbf{b} \vDash \varphi(y,\mathbf{x}) \\
&\Rightarrow B,\mathbf{b} \vDash \forall y \varphi(y,\mathbf{x}) \\ 
&\Rightarrow B,\mathbf{b} \vDash \psi(\mathbf{x}) 
\end{align*}
The $\Leftarrow$-direction is similar. Therefore, for all $\psi(\mathbf{x}) \in \mathcal{L}_{\omega,k+1}$ with $n \leq k+1$, there exists $\mathbf{a} \in A^{n}$ and $\mathbf{b} \in B^{n}$ such that $A,\mathbf{a} \vDash \psi(\mathbf{x}) \Leftrightarrow B,\mathbf{b} \vDash \psi(\mathbf{x})$. In particular, for sentences $\phi \in \mathcal{L}_{\omega,k+1}$, $A \vDash \phi \Leftrightarrow B \vDash \phi$, so $\equivL{A}{B}{\mathcal{L}_{\omega,k+1}}$. 
\end{proof}
\begin{cor}
Suppose $A,B$ are pure $\sigma'$-structures, then the following are equivalent:
\begin{enumerate}[label=(\arabic*)]
\item $\equivL{A}{B}{\mathcal{L}_{\omega,k}}$ 
\item There exist $\sigma'$-morphisms $f:\efcomonad{k}{A} \longrightarrow B$, $g:\efcomonad{k}{B} \longrightarrow A$ such that $S_{f} = S_{g}^{-}$ 
\item There exists $f:\efcomonad{k}{A} \longrightarrow B$ winning for Duplicator in $\efgameSym{k}{A}{B}$ 
\end{enumerate}
\begin{proof}
$(1) \Rightarrow (2)$ By proposition (\ref{prop:backForthSyntaxEF}), there exists a strategy in positional form $S$ winning for Duplicator in $\efgameSym{k}{A}{B}$. Hence, $S$ winning for Duplicator in $\efgame{k}{A}{B}$ and $S^{-}$ winning for Duplicator in $\efgame{k}{B}{A}$. By theorem (\ref{thm:toPositionalFormEF}), there exists $\sigma'$-morphisms $f:\efcomonad{k}{A} \longrightarrow B$, $g:\efcomonad{k}{B} \longrightarrow A$ with $S_{f} = S$, and $S^{-} = S_{g}$. \\ 
$(2) \Rightarrow (3)$ Straightforward from definition of $f$ winning for Duplicator in $\efgameSym{k}{A}{B}$. \\ 
$(3) \Rightarrow (1)$ By proposition (\ref{prop:backForthSyntaxEF}) with $S_{f}$ witnessing $S$.  
\end{proof}
\label{cor:backForthEF}
\end{cor}
\label{prop:backForthSyntaxEF}
\end{prop}
\subsection{Equivalence $\mathcal{L}_{\infty,k}(\mathsf{Cnt})$} 
The $k$-round bijective Ehrenfreucht-{\Fraisse} game between two pure $\sigma'$-structures $A,B$, $\efgameBij{k}{A}{B}$ is played by Spoiler and Duplicator as follows:
\begin{itemize}
\item If cardinality of $A$ is not equal to the cardinality of $B$, then Spoiler wins the game.
\item If cardinality of $A$ is equal to the cardinality of $B$, then for each round $i = 1,\dots,k$, Duplicator selects a bijection $\psi_{i}:A \longrightarrow B$ and Spoiler selects a point $a_{i} \in A$. 
\item Duplicator wins if for $b_{i} = \psi_{i}(a_{i})$, the map $\chi:a_{i} \mapsto b_{i}$ is a partial isomorphism from $A$ to $B$. 
\end{itemize}
The game $\efgameBij{k}{A}{B}$ characterizes equivalence in the $k$-rank fragment of $\mathcal{L}_{\infty,\omega}(\mathsf{Cnt})$. Namely,
\begin{prop}[{\cite{Hella1996}}]
The following are equivalent: 
\begin{itemize}
\item Duplicator has a winning strategy in $\efgameBij{k}{A}{B}$ 
\item $\equivL{A}{B}{\mathcal{L}_{\infty,k}(\mathsf{Cnt})}$ 
\end{itemize}
\label{prop:bijToSyntaxEF}
\end{prop}
Our goal is to show that isomorphism in the coKleisli category internalizes $\efgameBij{k}{A}{B}$. Suppose $f:\efcomonad{k}{A} \longrightarrow B$ is a $\sigma$-morphism. For all $s \in \efcomonad{k}{A} \cup \{\emptySeq\}$, define the function $\psi_{s}:A \longrightarrow B$ by $a \mapsto f(s[a])$. Using these functions and the following definition we can show that isomorphism in the coKleisli category internalizes $\efgameBij{k}{A}{B}$ and characterizes equivalence in $\mathcal{L}_{\infty,k}(\mathsf{Cnt})$.
\begin{defn}
Given $f:\efcomonad{k}{A} \longrightarrow B$, $f$ is \textit{winning for Duplicator in $\efgameBij{k}{A}{B}$} if $\psi_{s}$ bijective for all $s \in \efcomonad{k}{A} \cup \{\emptySeq\}$ 
\end{defn}
\begin{prop}
$f:\efcomonad{k}{A} \longrightarrow B$ an isomorphism in $\mathcal{K}(\efcomonad{k}{})$ if and only if $f$ is winning for Duplicator in $\efgameBij{k}{A}{B}$  
\begin{proof}
$\Rightarrow$ If $f:\efcomonad{k}{A} \longrightarrow B$ is an isomorphism in $\mathcal{K}(\efcomonad{k}{})$, then there exists a $g:\efcomonad{k}{B} \longrightarrow A$ such that $f \circ_{\mathcal{K}} g = \epsilon_{B}$ and $g \circ_{\mathcal{K}} f = \epsilon_{A}$. Suppose $s \in \efcomonad{k}{A} \cup \{\emptySeq\}$, then we aim to show that $\psi_{s}:A \longrightarrow B$ is bijective. Let $t = f^{*}(s)$ (or $t = \emptySeq$ if $s = \emptySeq$) and define $\phi_{t}:B \longrightarrow A$ by $\phi_{t}(b) = g(t[b])$.   
\begin{align*}
\phi_{t} \circ \psi_{s}(a) &= \phi_{t}(f(s[a])) \\
&= g(t[f(s[a]])) \\
&= g(f^{*}(s)[f(s[a]])) \\
&= g(f^{*}(s[a])) \\
&= g \circ_{\mathcal{K}} f(s[a]) \\
&= \epsilon_{A}(s[a]) \\
&= a 
\end{align*}
The proof that $\psi_{s} \circ \phi_{t}(b) = b$ is similar. Therefore, $\psi_{s}$ is bijective. \\
$\Leftarrow$ Let $f:\efcomonad{k}{A} \longrightarrow B$ be the $\sigma$-morphism witnessing Duplicator winning in $\efgameBij{k}{A}{B}$. Define $g^{*}:\efcomonad{k}{B} \longrightarrow \efcomonad{k}{A}$ (i.e. the coextension of $g = \epsilon_{A} \circ g^{*}$) by recursion, up to $k$, on length of $t \in \efcomonad{k}{B}$. \\   
\textit{Base Case:} Suppose $t = [b]$ for $b \in B$, let $g^{*}([b]) = [\psi_{\emptySeq}^{-1}(b)]$.
\textit{Recursion Step:} Assume for $t \in B$ with length $|t| = n < k$ that $g^{*}(t)$ is already defined. Consider $t' = t[b]$ for $b \in B$. Let $g^{*}(t') = g^{*}(t)\psi_{s}^{-1}(b)$ where $s = g^{*}(t) \in \efcomonad{k}{A}$. To complete, the proof, we need to show that $f \circ_{\mathcal{K}} g = \epsilon_{B}$ and $g \circ_{\mathcal{K}} f = \epsilon_{A}$. Suppose $s' = s[a_{n}] = [a_{1},\dots,a_{n}] \in \efcomonad{k}{A}$ and $f(s') = b_{n}$ (i.e. it follows that $\psi_{s}(a_{n}) = b_{n}$) then: 
\begin{align*}
g \circ_{\mathcal{K}} f([a_{1},\dots,a_{n}]) &= g \circ \efcomonad{k}{f} \circ \delta_{A}([a_{1},\dots,a_{n}]) \\ 
&= g \circ \efcomonad{k}{f}([[a_{1}],\dots,[a_{1},\dots,a_{n}]]) \\
&= g(f([a_{1}]),\dots,f([a_{1},\dots,a_{n}])) \\
&= g([b_{1},\dots,b_{n}]) \\
&= \psi_{s}^{-1}(b_{n})  \\
&= a_{n} \\ 
&= \epsilon_{A}(s[a_{n}]) 
\end{align*}
The proof $f \circ_{\mathcal{K}} g = \epsilon_{B}$ is similar. By definition, $f: \efcomonad{k}{A} \longrightarrow B$ is an isomorphism in the coKleisli category.  
\end{proof}
\begin{cor}
$A,B$ are isomorphic in $\mathcal{K}(\efcomonad{k}{})$ if and only if $\equivL{A}{B}{\mathcal{L}_{\infty,k}(\mathsf{Cnt})}$.
\begin{proof}
Follows from (\ref{prop:bijToSyntaxEF}) and (\ref{prop:bijEF})
\end{proof}
\end{cor}
\label{prop:bijEF}
\end{prop}
\section{Coalgebras and Tree-Depth}
An advantage of the comonad perspective is exploring the structure of the category of coalgebras over $\efcomonad{k}{}$ to give a categorical characterization of combinatorial properties of structures. In particular, we use the coalgebra category of $\efcomonad{k}{}$ to give a categorical definition for tree-depth of a $\sigma$-structure $A$. Recall a coalgebra for $\efcomonad{k}{}$ is an object $A$ and morphism $\alpha:A \longrightarrow \efcomonad{k}{A}$ such that the following diagrams commute:
\begin{equation}
\bfig 
    \square[A`\efcomonad{k}{A}`\efcomonad{k}{A}`\efcomonad{k}{\efcomonad{k}{A}};\alpha`\alpha`\delta_{A}`\efcomonad{k}{\alpha}]
\efig 
\bfig
    \qtriangle[A`\efcomonad{k}{A}`A;\alpha`\mathsf{id}_{A}`\epsilon_{A}]
\efig
\label{eq:coalgebraLawEF}
\end{equation}
There are many equivalent ways to define the notion of tree-depth of a $\sigma$-structure $A$. We use the one given in \cite{Rossman2008} and is stated in definition (\ref{defn:treeDepth}). 
\begin{defn}
A \textit{forest} $\mathcal{F}$ is a disjoint union of finitely-many finite rooted trees. The \textit{height} of the forest is the longest path between two vertices in $\mathcal{F}$
\end{defn}
\begin{defn}
Given an undirected graph $G$, a \textit{forest cover of $G$} is a forest $\mathcal{F}$ such that $G$ is a subgraph of $\overline{\mathcal{F}}$ where $\overline{\mathcal{F}}$ is the transitive closure of $\mathcal{F}$
\end{defn}
Recall the definition (\ref{defn:gaifmanGraph}) of the Gaifman graph $\mathcal{G}(A)$ of a $\sigma$-structure $A$.
\begin{defn}
Given a $\sigma$-structure $A$, the \textit{tree-depth} of $A$, denoted $\mathsf{td}(A)$, is the least height of a forest cover $\mathcal{F}$ for $\mathcal{G}(A)$. 
\label{defn:treeDepth}
\end{defn}
\begin{prop}
Let $A$ be a finite $\sigma$-structure. There is a bijective correspondence between:
\begin{enumerate}[label=(\arabic*)]
\item coalgebras $\alpha:A \longrightarrow \efcomonad{k}{A}$
\item Forest covers $\mathcal{F}$ of $\mathcal{G}(A)$ with height $k$ 
\end{enumerate}
\begin{proof}
For the $(1) \Rightarrow (2)$ correspondence, suppose $\alpha:A \rightarrow \efcomonad{k}{A}$ is a coalgebra. Construct a forest $\mathcal{F}_{n}$ for every $n \leq k$ by recursion. Let $V(\mathcal{F})$ and $E(\mathcal{F})$ denote the vertices and edge relation of forest $\mathcal{F}$. \\
\textit{Base Case:} $$V(\mathcal{F}_{1}) := \{a \in A \mid \alpha(a) = [a]\}, E(\mathcal{F}_{1}) = \varnothing$$
\textit{Recursive Step:} Assume that $\mathcal{F}_{n}$ is a forest that has been constructed. From the counit coalgebra law (\ref{eq:coalgebraLaw} right), it must be the case that $\alpha(a) = s$ where the last move in $s$ is $a$ (i.e. $\epsilon_{A}(s) = a$). Let $a^{-}$ be the second-to-last move in $s$ (i.e $s = t[a^{-},a] = t[a^{-},\epsilon_{A}(s)]$ for some possibly empty sequence $t$). Define $\mathcal{F}_{n+1}$ as follows:  
$$V(\mathcal{F}_{n+1}) := V(\mathcal{F}_{n}) \cup \{a \in A \mid a^{-} \in V(\mathcal{F}_{n})\}$$
$$E(\mathcal{F}_{n+1}) := E(\mathcal{F}_{n}) \cup \{(a^{-},a) \mid a \in  V(\mathcal{F}_{n+1})\}$$ 
Let $\mathcal{F} = \mathcal{F}_{k}$ be the forest constructed at the end of the recursion up to $k$. Suppose $(a,a')$ is an edge in $\mathcal{G}(A)$, the by the definition of Gaifman graph there exists an $R \in \sigma$ such that $a$ and $a'$ appear in a tuple of $R^{A}$. By $\alpha$ a $\sigma$-morphism, $\alpha(a)$ and $\alpha(a')$ appear in a tuple of $R^{\efcomonad{k}{A}}$. By condition (1) in the definition $R^{\efcomonad{k}{A}}$, $\alpha(a) \sqsubseteq \alpha(a')$ or $\alpha(a') \sqsubseteq \alpha(a)$. Without loss of generality, assume $\alpha(a) \sqsubseteq \alpha(a')$, and let $t$ be the suffix of $\alpha(a)$ in $\alpha(a')$. From the construction of $\mathcal{F}$, $[a]t$ describes a path between $a$ and $a'$ in $\mathcal{F}$. Hence, $(a,a') \in \overline{\mathcal{F}}$. Since $(a,a')$ was arbitrary in $\mathcal{G}(A)$, $\mathcal{G}(A)$ is a subgraph of $\overline{\mathcal{F}}$. Therefore, $\mathcal{F}$ is a forest cover of $\mathcal{G}(A)$ as desired. \\~\\
For the $(2) \Rightarrow (1)$ correspondence, suppose $\mathcal{F}$ is a forest cover of $\mathcal{G}(A)$ of height $k$. Consider arbitrary $a \in A$. Since $\mathcal{F}$ is a cover of $\mathcal{G}(A)$, $a \in \mathcal{F}$. By definition of forest as a disjoint union finite trees, $a$ is in a unique tree $T \subseteq \mathcal{F}$. Let $a^{*}$ be the root of tree $T$. By $T$ being a tree, there exists a unique path $u = [a^{*},\dots,a]$ between $a^{*}$ and $a$. Let $\alpha(a) = u$ with $u$ considered as an element of $\efcomonad{k}{A}$. It is straightforward to see that $\alpha$ as defined satisfies the coalgebra laws (\ref{eq:coalgebraLaw}). 
\end{proof}
\label{prop:coalgebraForest}
\begin{defn}
Given a $\sigma$-structure $A$, define the \textit{$\mathbb{E}$-coalgebra number of $A$}, denoted $\kappa(A)$, as the least $k$ such that there exists a coalgebra $\alpha:A \longrightarrow \efcomonad{k}{A}$. 
\end{defn}
\begin{cor}
$\kappa(A) = \mathsf{td}(A)$
\begin{proof}
By definition of coalgebra number $\kappa(A)$ there exists a coalgebra $\alpha:A \longrightarrow \efcomonad{\kappa(A)}{A}$. By proposition (\ref{prop:coalgebraForest}), there exists a corresponding forest cover $\mathcal{F}$ of $\mathcal{G}(A)$. The height of $\mathcal{F}$ is $\kappa(A)$. Hence, $\mathsf{td}(A) \leq \kappa(A)$ by definition of tree-depth as the least height of forest covers. Similarly, by definition of tree-depth $\mathsf{td}(A)$, there exists a forest cover $\mathcal{F}$ of $\mathcal{G}(A)$ of height $k = \mathsf{td}(A)$. By proposition (\ref{prop:coalgebraForest}), there exists a corresponding coalgebra $\alpha:A \longrightarrow \efcomonad{k}{A}$. Hence, $\kappa(A) \leq k$ by definition of $\kappa(A)$. Therefore, $\mathsf{td}(A) \leq \kappa(A)$ and $\mathsf{td}(A) \geq \kappa(A)$, so $\kappa(A) = \mathsf{td}(A)$.      
\end{proof}
\label{cor:treeDepth}
\end{cor}
\end{prop}
Hence, as the above corollary (\ref{cor:treeDepth}) shows, the graded family of comonads $\{\efcomonad{k}\}_{k \in \omega}$ gives a purely categorical definition of tree-depth of a structure $A$. Namely, the tree-depth of $A$ is just the least $k$ such that a coalgebra $\alpha:A \longrightarrow \efcomonad{k}{A}$ exists. 
